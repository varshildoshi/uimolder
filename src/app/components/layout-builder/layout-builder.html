<div class="h-screen flex flex-col bg-[#020617] text-slate-300 font-['Tomorrow']" cdkDropListGroup>

  <header class="h-16 border-b border-white/5 bg-black/40 flex items-center justify-between px-8 shrink-0 relative"
    [ngStyle]="{ 'margin-top': headerHeight() + 'px' }">
    <!-- Left Placeholder for centering -->
    <div class="w-48 hidden md:block"></div>

    <!-- Centered Flavor Selector (Only in Editor) -->
    @if (viewMode() === 'editor') {
    <div
      class="flex items-center gap-4 px-4 py-2 rounded-xl border border-white/10 bg-white/[0.05] backdrop-blur-xl animate-in fade-in duration-300">
      @for (flavor of flavors; track flavor.name) {
      <button (click)="activeFlavor.set(flavor.name)"
        class="flex items-center gap-2 text-sm font-medium transition-all px-3 py-1 rounded-lg" [ngClass]="{
                  'bg-white/10 backdrop-blur-md': activeFlavor() === flavor.name
              }">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path [attr.fill]="activeFlavor() === flavor.name ? flavor.color : 'rgba(255,255,255,0.5)'"
            [attr.d]="flavor.iconPath" />
        </svg>
        <span [style.color]="activeFlavor() === flavor.name ? flavor.color : 'rgb(148 163 184)'">{{
          flavor.label }}</span>
      </button>
      }
    </div>
    } @else {
    <div
      class="flex items-center gap-2 px-4 py-2 rounded-xl border border-brand-gold/20 bg-brand-gold/5 text-brand-gold font-mono text-[10px] uppercase tracking-[0.2em]">
      <mat-icon class="text-sm">visibility</mat-icon>
      Live Preview Mode
    </div>
    }

    <!-- Right Side Export -->
    <div class="w-48 flex justify-end">
      <button (click)="exportLayout()"
        class="bg-brand-gold hover:bg-brand-gold/80 text-black px-6 py-2 rounded-xl text-[12px] font-medium transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(251,191,36,0.2)]">
        <mat-icon class="text-[18px]">download</mat-icon>
        EXPORT LAYOUT
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar / Toolbox (Always visible, but disabled in preview) -->
    <aside class="w-72 border-r border-white/5 bg-white/[0.01] p-6 overflow-y-auto transition-all">
      <h2
        class="text-[14px] font-medium uppercase tracking-widest text-brand-gold border-b border-brand-gold/10 pb-2 mb-6">
        Fields</h2>

      <div id="toolbox-list" cdkDropList [cdkDropListData]="toolbox" [cdkDropListSortingDisabled]="true"
        [cdkDropListConnectedTo]="rowIds()" [cdkDropListDisabled]="viewMode() === 'preview'" class="space-y-4">
        @for (item of toolbox; track item.type) {
        <div cdkDrag [cdkDragData]="item" [cdkDragDisabled]="viewMode() === 'preview'"
          class="p-4 bg-white/[0.03] border border-white/10 rounded-xl transition-all flex items-center gap-3 group"
          [class.cursor-grab]="viewMode() === 'editor'" [class.opacity-50]="viewMode() === 'preview'">
          <div *cdkDragPreview
            class="flex items-center gap-3 p-2 bg-slate-900 border border-brand-gold rounded-xl text-white">
            <mat-icon class="text-brand-gold">drag_indicator</mat-icon>
            <span>{{item.label}}</span>
          </div>
          <mat-icon class="text-slate-500 group-hover:text-brand-gold">extension</mat-icon>
          <span class="text-sm font-medium">{{item.label}}</span>
        </div>
        }
      </div>
    </aside>

    <!-- Canvas area -->
    <section
      class="flex-1 bg-[radial-gradient(#ffffff05_1px,transparent_1px)] bg-[size:30px_30px] flex flex-col overflow-hidden">

      <div class="flex-1 p-8 overflow-y-auto flex flex-col gap-8">

        <!-- Canvas Controls -->
        <div class="max-w-5xl mx-auto w-full flex items-center justify-between">
          <!-- View Toggle (Left) -->
          <div class="flex items-center gap-1 bg-white/[0.05] p-1 rounded-xl border border-white/10 backdrop-blur-md">
            <button (click)="viewMode.set('editor')" [class.bg-brand-gold]="viewMode() === 'editor'"
              [class.text-black]="viewMode() === 'editor'"
              class="px-4 py-1.5 rounded-lg text-[12px] font-medium transition-all flex items-center gap-2 tracking-widest">
              <mat-icon class="text-[16px]">architecture</mat-icon>
              EDITOR
            </button>
            <button (click)="viewMode.set('preview')" [class.bg-brand-gold]="viewMode() === 'preview'"
              [class.text-black]="viewMode() === 'preview'"
              class="px-4 py-1.5 rounded-lg text-[12px] font-medium transition-all flex items-center gap-2 tracking-widest">
              <mat-icon class="text-[16px]">visibility</mat-icon>
              PREVIEW
            </button>
          </div>

          <!-- Add Row Button (Right, Only in Editor) -->
          @if (viewMode() === 'editor') {
          <button (click)="addNewRow()"
            class="flex items-center gap-2 px-4 py-2 border border-brand-gold/20 bg-brand-gold/5 text-brand-gold rounded-xl text-[10px] font-bold uppercase hover:bg-brand-gold hover:text-black transition-all animate-in zoom-in duration-300">
            <mat-icon class="text-sm">add</mat-icon>
            Add Row
          </button>
          }
        </div>

        <!-- Rows Container -->
        <div class="flex flex-col" [ngClass]="viewMode() === 'editor' ? 'gap-4' : 'gap-4'">
          @for (row of formRows(); track row.id) {
          <div class="relative group/row max-w-5xl mx-auto w-full">
            <!-- Drop List -->
            <div [id]="row.id" cdkDropList [cdkDropListData]="row.fields" [cdkDropListConnectedTo]="rowIds()"
              [cdkDropListDisabled]="viewMode() === 'preview'" (cdkDropListDropped)="onDrop($event, row.id)"
              class="min-h-[100px] rounded-3xl transition-all relative" [ngClass]="{
                  'border-2 border-dashed border-slate-800 p-8 flex flex-col gap-6': viewMode() === 'editor',
                  'justify-center': viewMode() === 'editor' && row.fields.length === 0,
                  'bg-white/[0.02] border border-white/5 shadow-xl p-6 flex flex-col gap-4': viewMode() === 'preview'
                }">

              <!-- Row Header (Inside, Only in Editor) -->
              @if (viewMode() === 'editor') {
              <div class="flex items-center justify-between mb-2 animate-in fade-in duration-300">
                <div class="flex items-center gap-3">
                  <span class="text-[12px] font-medium text-brand-gold/50 uppercase tracking-widest">Row</span>
                </div>
                @if (formRows().length > 1) {
                <button (click)="removeRow(row.id)" class="text-slate-600 hover:text-red-500">
                  <mat-icon class="text-sm">delete</mat-icon>
                </button>
                }
              </div>
              }

              @if (row.fields.length === 0 && viewMode() === 'editor') {
              <div class="w-full flex items-center justify-center text-slate-700 pointer-events-none empty-placeholder">
                <p
                  class="font-mono text-[14px] uppercase tracking-widest transition-all duration-300 border-b-2 border-transparent">
                  Drop elements here</p>
              </div>
              }

              @for (item of row.fields; track item.id) {
              <div (click)="viewMode() === 'editor' ? selectedElementId.set(item.id) : null" cdkDrag
                [cdkDragDisabled]="viewMode() === 'preview'"
                class="rounded-lg relative group/field transition-all w-full" [ngClass]="{
                      'bg-white/[0.02] border border-white/10 cursor-pointer p-4': viewMode() === 'editor',
                      'ring-2 ring-brand-gold': viewMode() === 'editor' && selectedElementId() === item.id,
                      'bg-transparent border-0 p-2': viewMode() === 'preview'
                    }">

                <!-- Management Controls (Only in Editor) -->
                @if (viewMode() === 'editor') {
                <button (click)="removeItem(item.id, $event)"
                  class="absolute -top-2 -right-2 w-7 h-7 bg-red-500/10 border border-red-500/20 text-red-500 rounded-full flex items-center justify-center opacity-0 group-hover/field:opacity-100 hover:bg-red-500 hover:text-white transition-all z-10">
                  <mat-icon class="text-sm">close</mat-icon>
                </button>

                <div
                  class="flex items-center justify-between mb-4 border-b border-white/5 pb-2 animate-in fade-in duration-300">
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                      <span class="text-[16px] text-slate-500 font-medium tracking-tight">{{item.label}}</span>
                      <span
                        class="px-1.5 py-0.5 rounded-md bg-brand-gold/10 border border-brand-gold/20 text-[10px] font-mono text-brand-gold uppercase tracking-widest">{{item.type}}</span>
                    </div>
                  </div>
                </div>
                } @else {
                <!-- Labels in Preview (Only for inputs) -->
                @if (item.type !== 'heading' && item.type !== 'button' && item.type !== 'card') {
                <label class="block text-sm font-medium text-slate-400 mb-2">{{item.label}}</label>
                }
                }

                <!-- Actual Element Rendering -->
                <div class="relative">
                  @switch (item.type) {
                  @case ('heading') { <h2 class="text-lg font-bold text-white"
                    [class.text-2xl]="viewMode() === 'preview'" [class.border-b]="viewMode() === 'preview'"
                    [class.border-white/10]="viewMode() === 'preview'" [class.pb-2]="viewMode() === 'preview'">
                    {{item.label}}</h2> }
                  @case ('input') {
                  <input [(ngModel)]="item.props.value" [placeholder]="item.props.placeholder"
                    class="bg-white/5 border border-white/10 p-2 rounded text-xs text-white w-full outline-none focus:border-brand-gold"
                    [class.p-3]="viewMode() === 'preview'" [class.text-sm]="viewMode() === 'preview'">
                  }
                  @case ('textarea') {
                  <textarea [(ngModel)]="item.props.value" [placeholder]="item.props.placeholder"
                    [rows]="viewMode() === 'preview' ? 4 : 2"
                    class="bg-white/5 border border-white/10 p-2 rounded text-xs text-white w-full outline-none focus:border-brand-gold"
                    [class.p-3]="viewMode() === 'preview'" [class.text-sm]="viewMode() === 'preview'"></textarea>
                  }
                  @case ('button') { <button
                    class="bg-brand-gold text-black px-4 py-1.5 rounded text-xs font-bold w-full"
                    [class.py-3]="viewMode() === 'preview'"
                    [class.text-sm]="viewMode() === 'preview'">{{item.label}}</button> }
                  @case ('card') {
                  <div class="p-4 bg-white/5 border border-white/10 rounded-lg" [class.p-6]="viewMode() === 'preview'">
                    <h3 class="text-sm font-bold" [class.text-lg]="viewMode() === 'preview'">{{item.props.title ||
                      item.label}}</h3>
                    <div class="mt-2 border border-dashed border-white/5 rounded" [class.h-8]="viewMode() === 'editor'"
                      [class.h-20]="viewMode() === 'preview'"></div>
                  </div>
                  }
                  @case ('dropdown') {
                  <select [(ngModel)]="item.props.value"
                    class="bg-white/5 border border-white/10 p-2 rounded text-xs text-white w-full outline-none focus:border-brand-gold"
                    [class.p-3]="viewMode() === 'preview'" [class.text-sm]="viewMode() === 'preview'">
                    <option value="">Select Option</option>
                    <option value="1">Option 1</option>
                  </select>
                  }
                  @case ('checkbox') {
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" [(ngModel)]="item.props.value" class="accent-brand-gold"
                      [class.w-5]="viewMode() === 'preview'" [class.h-5]="viewMode() === 'preview'">
                    <span class="text-xs text-slate-400" [class.text-sm]="viewMode() === 'preview'"
                      [class.text-slate-300]="viewMode() === 'preview'">{{item.label}}</span>
                  </label>
                  }
                  @case ('radio') {
                  <div class="flex flex-col gap-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" [name]="item.id + (viewMode() === 'preview' ? '_prev' : '')"
                        [(ngModel)]="item.props.value" value="1" class="accent-brand-gold">
                      <span class="text-xs text-slate-400" [class.text-sm]="viewMode() === 'preview'"
                        [class.text-slate-300]="viewMode() === 'preview'">Option 1</span>
                    </label>
                  </div>
                  }
                  @case ('datepicker') {
                  <input type="date" [(ngModel)]="item.props.value"
                    class="bg-white/5 border border-white/10 p-2 rounded text-xs text-white w-full outline-none focus:border-brand-gold"
                    [class.p-3]="viewMode() === 'preview'" [class.text-sm]="viewMode() === 'preview'">
                  }
                  @default {
                  <div class="italic text-slate-600 text-[10px]">Preview UI Placeholder</div>
                  }
                  }
                </div>

                <div *cdkDragPlaceholder
                  class="bg-brand-gold/10 border-2 border-dashed border-brand-gold rounded-2xl h-full w-full"></div>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>

    </section>

    <!-- Right Sidebar / Properties (Always visible) -->
    <aside class="w-80 border-l border-white/5 bg-white/[0.01] p-6 overflow-y-auto transition-all">
      <h3
        class="text-[14px] font-medium uppercase tracking-widest text-brand-gold border-b border-brand-gold/10 pb-2 mb-6">
        Fields Configuration</h3>

      @if (activeComponent(); as comp) {
      <div class="space-y-6 animate-in fade-in duration-300">
        <div class="space-y-2">
          <label class="text-[10px] text-slate-500 uppercase font-bold">Label</label>
          <input [ngModel]="comp.label" (ngModelChange)="updateLabel($event)"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-white focus:border-brand-gold outline-none"
            [disabled]="viewMode() === 'preview'">
        </div>

        @if (comp.type === 'input' || comp.type === 'textarea') {
        <div class="space-y-2">
          <label class="text-[10px] text-slate-500 uppercase font-bold">Placeholder</label>
          <input [ngModel]="comp.props.placeholder" (ngModelChange)="updateProp('placeholder', $event)"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-white focus:border-brand-gold outline-none"
            [disabled]="viewMode() === 'preview'">
        </div>
        }

        @if (comp.type === 'card') {
        <div class="space-y-2">
          <label class="text-[10px] text-slate-500 uppercase font-bold">Card Title</label>
          <input [ngModel]="comp.props.title" (ngModelChange)="updateProp('title', $event)"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-white focus:border-brand-gold outline-none"
            [disabled]="viewMode() === 'preview'">
        </div>
        }
      </div>
      } @else {
      <div class="text-[14px] text-slate-600 text-center mt-20 italic">Select a component to customize</div>
      }
    </aside>
  </div>
</div>